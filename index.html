<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
    <link href="css\bootstrap.css" rel="stylesheet">
    <link href="styles(test).css" rel="stylesheet" media="screen">
    <script type="text/javascript" src="js\jquery-1.11.3.min.js"></script>
  </head>

  <body>
   
    <div class="contain">
      <!-- start solidPanel -->
      <div class="panel" id="solidPanel">
        
        <!-- Cancel Button -->
        <div class="button buttonCircle buttonSolid" id="cancelButtonSolid">
          <button>X</button>
        </div>  

        <!-- Starting Location Field -->
        <div class="nav-row-Solid">
          <div class="input-frame col-xs-12">
            <div class="labelSolid col-xs-2">O</div>
            <div class="col-xs-10">
              <input type="text" placeholder="Enter Origin Address" id="startSolid"  class="input-field-Solid ">
              <div class="underlineSolid"></div>
            </div>
          </div>

        </div><!-- end nav-row -->

        <!-- First Destination Field -->
        <div class="nav-row-Solid">
          <div class="input-frame col-xs-12">
            <div class="labelSolid col-xs-2">D</div>
            <div class="col-xs-10">
              <input type="text" placeholder="Enter Destination" id="destinationSolid_1"  class="input-field-Solid">
              <div class="underlineSolid"></div>
            </div>
          </div>

        </div><!-- end nav-row -->

        <!-- Add Button -->
        <div class="addDestination">
          <div class="button buttonCircle buttonSolid buttonRight" id="addButtonSolid">
            <button>+</button>
          </div>
        </div>

        <!-- Optimize Route Button -->
        <button class="button buttonSquared buttonSolid" id="optimizeButton">Optimize Route</button>

        <!-- Get Route Button -->
        <div class="bottomBar">
          <div class="button buttonSquared buttonSolid buttonRight" id="goButtonSolid">
            <button>Get Route</button>
          </div>        
        </div>

      </div><!-- end solidPanel --> 

      <!-- start floatingPanel -->
      <div class="panel" id="floatingPanel">
        <div class="topBar"></div>

        <!-- Cancel Button -->
        <div class="button buttonCircle buttonFloat" id="cancelButtonFloat">
          <button>X</button>
        </div>  

        <div class="nav-row start-row">
        
          <div class="input-frame col-xs-8">
            <input type="text" placeholder="Enter Origin Address" id="startFloat"  class="input-field">
            <div class="underline"></div>
          </div><!-- end input-frame -->

        </div> <!-- end nav-row -->

        <div class="nav-row destination-row">
          <div class="col-xs-2 cancelButton"></div>
          <div class="input-frame col-xs-8">
            <input type="text" placeholder="Enter Destination Address 1"  id="destinationFloat_1" class="input-field">
            <div class="underline"></div>
          </div><!-- end input-frame -->
        </div> <!-- end nav-row --> 
      
        <!-- Add Button -->
        <div class="addDestination">
          <div class="button buttonCircle buttonFloat buttonRight" id="addButtonFloat">
            <button>+</button>
          </div>
        </div>

        <!-- Get Directions Button -->
        <div class="bottomBar">
          <div class="button buttonSquared buttonFloat buttonRight" id="goButtonFloat">
            <button>Get Directions</button>
          </div>        
        </div>

      </div><!-- end floatingPanel -->

    </div><!-- end contain -->


    <div id="map"></div>

    <!-- page interactions -->
    <script>
     

    //TODO: change var to const OR let?
      var container = document.querySelector('.contain');
      var addButtonFloat = document.querySelector('#addButtonFloat');
      var goButtonFloat = document.querySelector('#goButtonFloat');
      var cancelButton = document.querySelector('#cancelButtonSolid');
      var addButtonSolid = document.querySelector('#addButtonSolid');
      var goButtonSolid = document.querySelector('#goButtonSolid');
      var optimizeButton = document.querySelector('#optimizeButton');

     //function to toggle change of panels
      function changePanel(evt){
        container.classList.toggle('panel-change');
      }

      //change to solidPanel by clicking 'Go'
      goButtonFloat.addEventListener('click', changePanel, false);

      //change to floatingPanel by clicking 'X'
      cancelButton.addEventListener('click', changePanel);
    

    //Maps API 
       
      function initMap() {
        var optimizeRoute = false;


        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.7833, lng: -122.4167},
          zoom: 13
        });

        //DESCRIPTION: initializes AutoComplete
        startAutocomplete = new google.maps.places.Autocomplete((document.getElementById('startFloat')));

        endAutocomplete = new google.maps.places.Autocomplete((document.getElementById('destinationFloat_1')));

        startAutocompleteSolid = new google.maps.places.Autocomplete((document.getElementById('startSolid')));

        destination_1AutocompleteSolid = new google.maps.places.Autocomplete((document.getElementById('destinationSolid_1')));

        places = new google.maps.places.PlacesService(map);

        

        //DESCRIPTION: Changes map Location to address selected from AutoComplete
        startAutocomplete.addListener('place_changed', onPlaceChanged);

        function onPlaceChanged() {
          var place = startAutocomplete.getPlace();
          if (place.geometry) {
            map.panTo(place.geometry.location);
            map.setZoom(15);
            search();
          } else {
            document.getElementById('startFloat').placeholder = 'Enter Origin Address';
          }
        }

        //DESCRIPTION: Calculate and display directions
        directionsDisplay.setMap(map);

        //move places values from floatingPanel to solidPanel


        var floatToSolid = function() {
          document.getElementById('startSolid').value = document.getElementById('startFloat').value;
          document.getElementById('destinationSolid_1').value = document.getElementById('destinationFloat_1').value;
        };

        var onChangeHandler = function() {
          calcRoute(storeWaypoints(), optimizeRoute);
        };

        var inputCount = 2;

        //DESCRIPTION: create new destination/waypoint input
        //TODO: clean up waypoint count
        var createInput = function () {

          //waypoint_x.innerHtml = solidPanelDiv.children[2].innerHtml;
          //change id

          if (inputCount <= 4){
            //append new input after third child of <div class="panel solidPanel">
            var solidPanelDiv = document.getElementById('solidPanel');

            //create containing div's
            var rowDiv = document.createElement('div');
            rowDiv.className = 'nav-row-Solid';
            solidPanelDiv.insertBefore(rowDiv, solidPanelDiv.children[inputCount]);


            var inputFrame = document.createElement('div');
            inputFrame.className = 'input-frame col-xs-12';
            rowDiv.appendChild(inputFrame);

            //create new input
            //TODO: add in bullet points for each waypoint field
            var icon = document.createElement('div');
            icon.className = 'labelSolid col-xs-2';
            // icon.innerHTML =;
            inputFrame.appendChild(icon);

            var inputFrame2 = document.createElement('div');
            inputFrame2.className = 'col-xs-10';
            inputFrame.appendChild(inputFrame2);

            var input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter Address';
            input.className = 'input-field-Solid';
            input.id = 'waypoint_' + (inputCount-1);
            inputFrame2.appendChild(input);

            //create underline div
            var underline = document.createElement('div');
            underline.className = 'underlineSolid';
            inputFrame2.appendChild(underline); 

            destinationAutoComplete = new google.maps.places.Autocomplete((document.getElementById('waypoint_' + (inputCount-1))));           

            inputCount++;
          }
          
        };

        //TODO: clean up waypoint count
        var rearrangeWaypoints = function(arr) {
            //change arr[x] to waypoint_ + [x].value
            for (var i = 1; i <= arr.length; i++){
              getElementById('waypoint_' + (i)).value = arr[i-1];
            }
        };

        //DESCRIPTION: stores waypoints in an array
        //TODO: clean up waypoint count
        var storeWaypoints = function () {
          var waypoints = [];
          var waypoint = "";

          for (var i = 1; i < inputCount-1; i++){
            waypoint = document.getElementById('waypoint_' + i).value;
            waypoints.push({location: waypoint});
          }
          return waypoints;
        };

        function getTravelDuration () {
          //get travel duration for routes w/ and w/out waypoints
        }

        function setMostEfficient (current, optimal, arr, unit, pushedObject) {
          if (current < optimal || optimal === 0){
            optimal = current;
            arr = [];
            for (var i = 0; i < unit.length-1; i++){
              arr.push(pushedObject);
            }
          }
        }

        //DESCRIPTION: produces every possible sequence/order of the elements of an array
        //ex. ABC ==> ABC, ACB, BCA, BAC, CAB, CBA
        function allCombinations (startingIndex, result, lastPush){
  
          for (var i = 1; startingIndex <= result[0].length-2; i++){

            var holder = lastPush.slice(0);
            
            allCombinations(startingIndex + 1, result, holder);

            if (startingIndex + i <= result[0].length-1){
              result.push(rotate(lastPush, startingIndex));   
            } else {return result;}   
          }
        }

        //rotates values of an array starting w/ a specified index 'start'
        //e.g. ABC will become BCA
        function rotate (arr, start){
          var holder = arr[start];
          for (var i = start; i < arr.length-1; i++){
            arr[i] = arr[i+1];
          }
            arr[arr.length-1] = holder;
            return arr.slice(0);
        }

        // document.getElementById('start').addEventListener('change', onChangeHandler);
       // document.getElementById('destinationFloat_1').addEventListener('change', onChangeHandler);
       function trueOptimize () {
          optimizeRoute = true;
       }



       //function onChangeHandler () {
        //test to see if 'optimizeButton' should be enabled
       //}

       function goButtonFloatHandler () {
        floatToSolid();
        changePanel();
        calcRoute(storeWaypoints(), optimizeRoute);
       }

       function cancelButtonFloatHandler () {
        //clear input fields
        //clear map
       }

       function cancelButtonFloatHandler () {
        //clear input fields
        //clear map
        //changePanel();
       }

       function goButtonSolidHandler () {
        storeWaypoints();
        calcRoute(storeWaypoints(), optimizeRoute);
       }

       function addButtonFloatHandler () {
        floatToSolid();
        createInput();
       }

       function optimizeButtonHandler () {
        optimizeRoute = true;
        calcRoute(storeWaypoints(), optimizeRoute);
       }

       function deleteButtonHandler () {
        //delete input
       }

        goButtonFloat.addEventListener('click', floatToSolid);
        goButtonFloat.addEventListener('click', onChangeHandler);

        optimizeButton.addEventListener('click', trueOptimize);
        //optimizeButton.addEventListener('click', storeWaypoints);
        optimizeButton.addEventListener('click', onChangeHandler);

        goButtonSolid.addEventListener('click', storeWaypoints);
        goButtonSolid.addEventListener('click', onChangeHandler);

        addButtonSolid.addEventListener('click', createInput);

        //build waypoints array IF there are waypoints

        //TODO: func parameters - waypoints, optimizeRoute, callBack?
        function calcRoute(waypoints, optimizeRoute) {


          var start = document.getElementById('startSolid').value;
          var destination_1 = document.getElementById('destinationSolid_1').value;

          
          // var waypoint = "";
          var waypointsArray = [];

          var travelTime = 0;
          var optimalTravelTime = 0;
          optimalRoute = [];

          var numRoute = 0;
          var gateOpen = true;

          //store location value of waypoints in an array      
          // for (var i = 1; i < inputCount-1; i++){
          //   waypoint = document.getElementById('waypoint_' + i).value;
          //   waypoints.push({location: waypoint});
          // }

          if (waypoints.length > 0){
            waypointsArray.push(waypoints.slice(0));
          }


          //produce array of all possible waypoint sequences
          if (optimizeRoute){
            if (waypoints.length > 1){ //TODO: if statement not necessary if optimizeRoute is disabled for waypoints.length < 2
              allCombinations (0, waypointsArray, waypoints.slice(0));
            }
          }

          //var x = 0; //TODO: try changing x=1, x < waypoints.length
          var x = 0;
          do {
          
            var request = {
              origin: start,
              destination: destination_1,
              waypoints: waypointsArray[x],
              optimizeWaypoints: false, //I build this feature
              travelMode: google.maps.TravelMode.DRIVING
           };

           x++;

          directionsService.route(request, function(result, status) {
            travelTime = 0;

            //get total travel duration
          if (waypointsArray.length > 0){
            for (var r = 0;  r < result.routes[0].legs.length; r++ ){
              travelTime += result.routes[0].legs[r].duration.value;
            }
          }

            

            if (optimizeRoute){
              //assign the optimal travel duration to optimatlTravleTime
              if (travelTime < optimalTravelTime || optimalTravelTime === 0){
                optimalTravelTime = travelTime;
                optimalRoute = [];
                for (var g = 0; g < result.routes[0].legs.length-1; g++){
                  optimalRoute.push({location: result.routes[0].legs[g].end_address});
                }
                // optimalRoute = waypointsArray[numRoute].slice(0);

              }

              //when waypointsArray has been exhausted push optimalRoute to waypointsArray, run the directions request 1 more time and display
              // TODO: clean up uneccesary else if's
              if (numRoute === waypointsArray.length-1 && gateOpen){
                gateOpen = false;
                  calcRoute(optimalRoute, false);
              } 

            } else if (status === google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(result);
                }

            numRoute++;                  

          });
            

          } while (x < waypointsArray.length);
        } 


            
          

        }


      //   function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      //     var waypoints = [];
      //     var waypoint = "";

      //     var start = document.getElementById('startSolid').value;
      //     var destination_1 = document.getElementById('destinationSolid_1').value;

      //     //store waypoints in an array      
      //     for (var i = 2; i < inputCount; i++){
      //       waypoint = document.getElementById('waypoint_' + i).value;
      //       waypoints.push({location: waypoint});
      //     }

        
          

      //   if(start !== "" && start !== null && destination_1 !== "" && destination_1 !== null ){
      //     directionsService.route({

      //       origin: start,
      //       destination: destination_1,
      //       waypoints: waypoints,
      //       optimizeWaypoints: false, //I build this feature
      //       travelMode: google.maps.TravelMode.DRIVING
      //     }, function(response, status) {
      //       if (status === google.maps.DirectionsStatus.OK) {
      //         directionsDisplay.setDirections(response);
      //       } else {
      //         window.alert('Directions request failed due to ' + status);
      //        }
      //     });
      //   }

      // }

     // } //end function initMap()


       

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDikBEU0kR-r0r_3Vibn1nvggdauVED7Zg&signed_in=true&libraries=places&callback=initMap"
        async defer></script>
        
  </body>
</html>

